//Запрос
//Выбираем заказ клиента из счета на оплату
//Выбираем из документа реализации информацию об отгрузке (если не все отгружено клиенту)
//Выбираем из регистра бухгалтерии - сколько осталось данного товара на складе
//Вычисляем, сколько товара не хватает, чтобы закрыть счет.

ВЫБРАТЬ
	СчетНаОплатуПокупателюТовары.Номенклатура,
	СчетНаОплатуПокупателюТовары.Количество,
	СчетНаОплатуПокупателюТовары.Ссылка КАК Счет
ПОМЕСТИТЬ ТоварыИзСчетов
ИЗ
	Документ.СчетНаОплатуПокупателю.Товары КАК СчетНаОплатуПокупателюТовары
ГДЕ
	НЕ СчетНаОплатуПокупателюТовары.Ссылка.ПометкаУдаления
	И СчетНаОплатуПокупателюТовары.Ссылка.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	РеализацияТоваровУслугТовары.Номенклатура,
	ЕСТЬNULL(РеализацияТоваровУслугТовары.Количество, 0) КАК Отгружено,
	ТоварыИзСчетов.Количество КАК Требуется
ПОМЕСТИТЬ СпросОтгрузка
ИЗ
	ТоварыИзСчетов КАК ТоварыИзСчетов
		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
		ПО ТоварыИзСчетов.Счет = РеализацияТоваровУслугТовары.Ссылка.СчетНаОплатуПокупателю
			И ТоварыИзСчетов.Номенклатура = РеализацияТоваровУслугТовары.Номенклатура
ГДЕ
	РеализацияТоваровУслугТовары.Ссылка.Проведен
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	СпросОтгрузка.Номенклатура,
	СпросОтгрузка.Требуется - ЕСТЬNULL(СпросОтгрузка.Отгружено, 0) - ЕСТЬNULL(ХозрасчетныйОстатки.КоличествоОстатокДт, 0) КАК ДевицитТовара,
	ХозрасчетныйОстатки.КоличествоОстатокДт,
	ХозрасчетныйОстатки.КоличествоОстаток
ИЗ
	СпросОтгрузка КАК СпросОтгрузка
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный.Остатки(
				,
				,
				&ВидСубконто,
				Субконто1 В
					(ВЫБРАТЬ
						ТоварыИзСчетов.Номенклатура
					ИЗ
						ТоварыИзСчетов КАК ТоварыИзСчетов)) КАК ХозрасчетныйОстатки
		ПО СпросОтгрузка.Номенклатура = ХозрасчетныйОстатки.Субконто1